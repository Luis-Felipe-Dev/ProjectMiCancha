{% extends '../base.html' %}
{% load static %}

{% block customCSS %}
  <style>
    #message_establishment,
    #message_field_soccer,
    #message_date {
        font-weight: bold;
    }

    .label_checkbox {
      display: inline-block;
      width: 125px;
      vertical-align: middle;
      {% comment %} background-color: transparent; {% endcomment %}
    }

    .label_checkbox.disabled {
        background-color: #F3401A;
    }
    
    .label_checkbox.checked {
        {% comment %} background-color: green; {% endcomment %}
    }
  </style>
{% endblock %}
{% block body %}
  <div class="page-body">
    <div class="container-fluid">
      <div class="page-header">
        <div class="row">
          <div class="col-sm-6">
            <h3>Reservaciones</h3>
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="{% url 'home' %}">Inicio</a>
              </li>
              <li class="breadcrumb-item">
                <a href="{% url 'appReservation.show' %}">Reservaciones</a>
              </li>
              <li class="breadcrumb-item">Registrar</li>
            </ol>
          </div>
          <div class="col-sm-6"></div>
        </div>
      </div>
    </div>
    <!-- Container-fluid starts -->
    <div class="container">
      <div class="row starter-main">
        <div class="col-sm-12">
          <div class="card">
            <form method="POST" class="post-form" action="" id="reservation_register">
              {% csrf_token %}
              <div class="card-body">
                <div class="form-group">
                  <label for="type_dist">Distrito:</label>
                  <select class="form-control" id="type_dist" name="type_dist" required>
                    <option value="">Selecione...</option>
                    {% for type_dist in type_district %}
                      <option value="{{ type_dist.id }}">{{ type_dist.description }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label for="establishment">Establecimiento: <span id="message_establishment"></span></label>
                  <select class="form-control" id="establishment" name="establishment" required>
                    <option value="">Selecione...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="field_soccer">Campo deportivo: <span id="message_field_soccer"></span></label>
                  <select class="form-control" id="field_soccer" name="field_soccer" required>
                    <option value="">Selecione...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="date_reservation">Fecha</label>
                  <input type="date" class="form-control" id="date_reservation" name="date_reservation" placeholder="" required />
                </div>

                <div class="checkbox-container">
                  <div class="row">
                    {% if now_filter < 9 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="09:00" /> 09:00 - 10:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 10 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="10:00" /> 10:00 - 11:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 11 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="11:00" /> 11:00 - 12:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 12 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="12:00" /> 12:00 - 13:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 13 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="13:00" /> 13:00 - 14:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 14 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="14:00" /> 14:00 - 15:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 15 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="15:00" /> 15:00 - 16:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 16 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="16:00" /> 16:00 - 17:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 17 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="17:00" /> 17:00 - 18:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 18 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="18:00" /> 18:00 - 19:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 19 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="19:00" /> 19:00 - 20:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 20 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="20:00" /> 20:00 - 21:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 21 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="21:00" /> 21:00 - 22:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 22 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="22:00" /> 22:00 - 23:00
                      </label>
                    </div>
                    {% endif %}
                    {% if now_filter < 23 %}
                    <div class="col-lg-3 col-sm-12 col-xs-12">
                      <label class="label_checkbox">
                        <input type="checkbox" name="option_hour" value="23:00" /> 23:00 - 00:00
                      </label>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="card-footer">
                <button type="submit" class="btn btn-primary">Registrar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Container-fluid Ends -->
  </div>
  {% block customJS %}
    {% if messages %}
      {% for message in messages %}
        <script>
          $(function () {
            var Toast = Swal.mixin({
              toast: true,
              position: 'top-right',
              showConfirmButton: false,
              timer: 5000
            })
            toastr.error('{{message}}')
          })
        </script>
      {% endfor %}
    {% endif %}
    <!-- latest jquery -->
    <script src="{% static 'assets/js/jquery-3.5.1.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script>
      document.getElementById('reservation_register').addEventListener('submit', function(event) {
        var checkboxes = document.querySelectorAll('input[name="option_hour"]:checked');
        if (checkboxes.length === 0) {
          event.preventDefault(); // Evitar que el formulario se envíe si no hay checkboxes marcados
          
          // Mostrar un SweetAlert indicando que al menos una hora debe ser seleccionada
          Swal.fire({
            icon: 'error',
            title: 'Ocurrió un error.',
            text: 'Debes marcar al menos una hora.',
          });
        }
      });
    </script>
    <script>
      $(document).ready(function() {
        $('#type_dist').change(function() {
          var type_dist_id = $(this).val();
          var select_establishment = $('select[name="establishment"]');
          var messageEstablishment = $('#message_establishment');
          var options = '<option value="">Seleccione...</option>'

          if (type_dist_id == "") {
            messageEstablishment.text('Por favor, seleccione un distrito.');
            messageEstablishment.css('color', 'red');
            select_establishment.html(options);
            $('#field_soccer').val('');
            $('#message_field_soccer').text('');
            $('select[name="establishment"]').empty().html(options);
            $('select[name="field_soccer"]').empty().html(options);
            $('#date_reservation').val('');
          } else {          
            $.ajax({
              url: `/reservation/get_establishment/${type_dist_id}/`,
              data: {
                'type_dist_id': type_dist_id
              },
              dataType: 'json',            
            }).done(function(data) {
                $.each(data.establishments, function(key, value){
                  options += `<option value="${value.id}">${value.name} - Dirección: ${value.location} - Cel.: ${value.phone}</option>`;
                });
              }).always(function(data){
                select_establishment.html(options)
  
                const establishmentsCount = data.establishments.length;
                if (establishmentsCount === 0) {
                    $('#message_establishment').text('No se encontraron establecimientos.');
                    $('#message_establishment').css('color', 'red');
                } else if (establishmentsCount === 1) {
                    $('#message_establishment').text(`Se encontró 1 establecimiento.`);
                    $('#message_establishment').css('color', 'green');
                } else {
                    $('#message_establishment').text(`Se encontraron ${establishmentsCount} establecimientos.`);
                    $('#message_establishment').css('color', 'green');
                }
              });
              $('#field_soccer').val('');
              $('#message_field_soccer').text('');
              $('select[name="field_soccer"]').empty().html(options);
              $('#date_reservation').val('');
          }
        });
        
        $('#establishment').change(function() {
          var establishment_id = $(this).val();
          var select_field_soccer = $('select[name="field_soccer"]');
          var messageFieldSoccer = $('#message_field_soccer');
          var options = '<option value="">Seleccione...</option>'

          if (establishment_id == "") {
            messageFieldSoccer.text('Por favor, seleccione un establecimiento.');
            messageFieldSoccer.css('color', 'red');
            select_field_soccer.html(options);
            $('#date_reservation').val('');
          } else {
            $.ajax({
              url: `/reservation/get_field_soccer/${establishment_id}/`,
              data: {
                'establishment_id': establishment_id
              },
              dataType: 'json',            
            }).done(function(data) {
                $.each(data.field_soccer, function(key, value){
                  options += `<option value="${value.id}">${value.name} - Capacidad: ${value.number_players/2} vs ${value.number_players/2}</option>`;
                });
              }).always(function(data){
                select_field_soccer.html(options)
  
                const fieldSoccerCount = data.field_soccer.length;
                if (fieldSoccerCount === 0) {
                    $('#message_field_soccer').text('No se encontraron campos deportivos.');
                    $('#message_field_soccer').css('color', 'red');
                } else if (fieldSoccerCount === 1) {
                    $('#message_field_soccer').text(`Se encontró 1 campo deportivo.`);
                    $('#message_field_soccer').css('color', 'green');
                } else {
                    $('#message_field_soccer').text(`Se encontraron ${fieldSoccerCount} campos deportivos.`);
                    $('#message_field_soccer').css('color', 'green');
                }
              });
              $('#date_reservation').val('');
          }
        });
        
        $('#field_soccer').change(function() {          
          $('#date_reservation').val('');
        })
        
        $('#date_reservation').change(function() {
          $('input[name="option_hour"]').prop('checked', false);
          $('input[name="option_hour"]').prop('disabled', false);
          $('input[name="option_hour"]').closest('.label_checkbox').removeClass('disabled');
          $('input[name="option_hour"]').closest('.label_checkbox').removeClass('checked');      
          var field_soccer_id = $('#field_soccer').val();
          var date_reservation = $(this).val();

          var selectedDate = new Date($(this).val() + "T00:00:00");
          // Obtiene el año, mes y día
          const year_select = selectedDate.getFullYear();
          const month_select = String(selectedDate.getMonth() + 1).padStart(2, '0'); // Months are zero-based, so add 1
          const day_select = String(selectedDate.getDate()).padStart(2, '0');
          // Formatea la fecha en el formato YYYY-MM-DD
          selectedDate = `${year_select}-${month_select}-${day_select}`;

          var currentDate = new Date();
          // Obtiene el año, mes y día
          const year = currentDate.getFullYear();
          const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // Months are zero-based, so add 1
          const day = String(currentDate.getDate()).padStart(2, '0');
          // Formatea la fecha en el formato YYYY-MM-DD
          currentDate = `${year}-${month}-${day}`;

          if (selectedDate >= currentDate) {              
            if (field_soccer_id && date_reservation) {
                $.ajax({
                    url: `/reservation/get_available_hours/${field_soccer_id}/${date_reservation}/`,
                    dataType: 'json',
                    success: function(data) {
                        // Manejar los datos de las horas disponibles devueltas en 'data.available_hours'
                        // console.log(data.available_hours);
                        // console.log(data.unavailable_hours);
        
                        // Desmarcar todos los checkboxes
                        $('input[name="option_hour"]').prop('checked', false);
        
                        // Deshabilitar los checkboxes correspondientes a las horas no disponibles
                        $('input[name="option_hour"]').prop('disabled', false);
  
                        // Iterar sobre las horas no disponibles (disabled) y cambiar el color de fondo a rojo
                        if (data && data.unavailable_hours) {
                          data.unavailable_hours.forEach(function(hour) {
                              var checkbox = $('input[name="option_hour"][value="' + hour + '"]');
                              checkbox.prop('disabled', true);
                              checkbox.closest('.label_checkbox').addClass('disabled');
                          });
                        }
  
                        // Iterar sobre las horas disponibles (checked) y cambiar el color de fondo a verde
                        if (data && data.available_hours) {
                          data.available_hours.forEach(function(hour) {
                              var checkbox = $('input[name="option_hour"][value="' + hour + '"]');
                              checkbox.prop('checked', false);
                              checkbox.closest('.label_checkbox').addClass('checked');
                          });
                        }
                        
                    },
                    error: function(xhr, status, error) {
                        // Manejar errores en la solicitud AJAX
                        console.error(error);
                    }
                });
            }
          } else {
            // Fecha inválida: oculta los checkboxes y muestra un mensaje de error          
            $('#date_reservation').val('');
            $('input[name="option_hour"]').prop('checked', false);
            $('input[name="option_hour"]').prop('disabled', true);
            $('input[name="option_hour"]').closest('.label_checkbox').removeClass('disabled');
            $('input[name="option_hour"]').closest('.label_checkbox').removeClass('checked');

            // Muestra un mensaje de error
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'La fecha seleccionada debe ser igual o posterior a la fecha actual.',
            });
          }
        });
        
      });
    </script>
    <script>
      {% if register_ok %}
      Swal.fire(
        '¡Excelente!',
        'Su mensaje fue enviado con éxito a los correos {{ recipients }}.',
        'success'
      ).then(function() {
          window.location.href = "{% url 'appReservation.show' %}";
      });
      {% endif %}
    </script>
  {% endblock %}
{% endblock %}
